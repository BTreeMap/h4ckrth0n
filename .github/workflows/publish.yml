name: publish.yml

on:
  push:
    branches: [main]
    tags: ["v*"]
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      channel:
        description: "Release channel override (dev|nightly|stable)"
        required: false
        default: ""

concurrency:
  group: publish
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies (locked)
        run: uv sync --locked --all-extras

      - name: Ruff format check
        run: uv run --locked ruff format --check .

      - name: Ruff lint
        run: uv run --locked ruff check .

      - name: Mypy
        run: uv run --locked mypy src

      - name: Pytest
        run: uv run --locked pytest -v

      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "npm"
          cache-dependency-path: packages/create-h4ckath0n/templates/fullstack/web/package-lock.json

      - name: Install frontend dependencies
        working-directory: packages/create-h4ckath0n/templates/fullstack/web
        run: npm ci

      - name: Lint frontend
        working-directory: packages/create-h4ckath0n/templates/fullstack/web
        run: npm run lint

      - name: Typecheck frontend
        working-directory: packages/create-h4ckath0n/templates/fullstack/web
        run: npm run typecheck

      - name: Test frontend
        working-directory: packages/create-h4ckath0n/templates/fullstack/web
        run: npm test

      - name: Build frontend
        working-directory: packages/create-h4ckath0n/templates/fullstack/web
        run: npm run build

  compute-version:
    runs-on: ubuntu-latest
    needs: quality
    outputs:
      npm_version: ${{ steps.compute.outputs.npm_version }}
      pypi_version: ${{ steps.compute.outputs.pypi_version }}
      dist_tag: ${{ steps.compute.outputs.dist_tag }}
      channel: ${{ steps.compute.outputs.channel }}
      base_version: ${{ steps.compute.outputs.base_version }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.14"

      - id: compute
        env:
          RELEASE_CHANNEL: ${{ inputs.channel }}
        run: python scripts/compute_versions.py

  check-existing:
    runs-on: ubuntu-latest
    needs: compute-version
    outputs:
      npm_exists: ${{ steps.check_npm.outputs.exists }}
      pypi_exists: ${{ steps.check_pypi.outputs.exists }}
    steps:
      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          registry-url: "https://registry.npmjs.org"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.14"

      - id: check_npm
        run: |
          if [ "${{ needs.compute-version.outputs.channel }}" != "nightly" ]; then
            echo "exists=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if npm view h4ckath0n@${{ needs.compute-version.outputs.npm_version }} version >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - id: check_pypi
        env:
          PYPI_VERSION: ${{ needs.compute-version.outputs.pypi_version }}
        run: |
          if [ "${{ needs.compute-version.outputs.channel }}" != "nightly" ]; then
            echo "exists=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          python - <<'PY'
          import json
          import os
          import urllib.request
          from urllib.error import HTTPError
          version = os.environ["PYPI_VERSION"]
          try:
            with urllib.request.urlopen("https://pypi.org/pypi/h4ckath0n/json") as response:
              data = json.load(response)
            exists = version in data.get("releases", {})
          except HTTPError as exc:
            if exc.code == 404:
              exists = False
            else:
              raise
          print(f"exists={str(exists).lower()}")
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as handle:
            handle.write(f"exists={str(exists).lower()}\n")
          PY

  build-python:
    runs-on: ubuntu-latest
    needs: [compute-version, check-existing]
    if: needs.check-existing.outputs.pypi_exists != 'true'
    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"
          cache: true
          cache-dependency-glob: "uv.lock"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.14"

      - name: Set up Python (uv)
        run: uv python install 3.11

      - name: Install dependencies (locked)
        run: uv sync --locked --all-extras

      - name: Apply version
        run: |
          python scripts/apply_versions.py \
            --npm-version "${{ needs.compute-version.outputs.npm_version }}" \
            --pypi-version "${{ needs.compute-version.outputs.pypi_version }}" \
            --channel "${{ needs.compute-version.outputs.channel }}"

      - name: Build package
        run: uv build

      - name: Upload dist
        uses: actions/upload-artifact@v6
        with:
          name: python-dist
          path: dist/*

  publish-python:
    runs-on: ubuntu-latest
    needs: [build-python, compute-version, check-existing]
    if: needs.check-existing.outputs.pypi_exists != 'true'
    permissions:
      id-token: write
      contents: read
    environment:
      name: pypi
      url: https://pypi.org/p/h4ckath0n
    steps:
      - name: Download dist
        uses: actions/download-artifact@v7
        with:
          name: python-dist
          path: dist

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist

  build-npm:
    runs-on: ubuntu-latest
    needs: [compute-version, check-existing]
    if: needs.check-existing.outputs.npm_exists != 'true'
    steps:
      - uses: actions/checkout@v6

      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "npm"
          cache-dependency-path: packages/create-h4ckath0n/package-lock.json

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.14"

      - name: Apply version
        run: |
          python scripts/apply_versions.py \
            --npm-version "${{ needs.compute-version.outputs.npm_version }}" \
            --pypi-version "${{ needs.compute-version.outputs.pypi_version }}" \
            --channel "${{ needs.compute-version.outputs.channel }}"

      - name: Install CLI dependencies
        working-directory: packages/create-h4ckath0n
        run: npm ci

      - name: Build CLI package
        working-directory: packages/create-h4ckath0n
        run: npm run build --if-present

      - name: Pack CLI package
        working-directory: packages/create-h4ckath0n
        run: |
          mkdir -p ../../dist-npm
          npm pack --pack-destination ../../dist-npm

      - name: Upload npm dist
        uses: actions/upload-artifact@v6
        with:
          name: npm-dist
          path: dist-npm/*.tgz

  publish-npm:
    runs-on: ubuntu-latest
    needs: [build-npm, compute-version, check-existing]
    if: needs.check-existing.outputs.npm_exists != 'true'
    permissions:
      id-token: write
      contents: read
    environment:
      name: npm
    steps:
      - name: Download npm dist
        uses: actions/download-artifact@v7
        with:
          name: npm-dist
          path: dist-npm

      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          registry-url: "https://registry.npmjs.org"

      - name: Publish to npm
        working-directory: dist-npm
        run: npm publish ./*.tgz --provenance --access public --tag "${{ needs.compute-version.outputs.dist_tag }}"
