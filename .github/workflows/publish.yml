name: publish.yml

on:
  push:
    branches: [main]
    tags: ["v*"]
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      channel:
        description: "Release channel override (dev|nightly|stable)"
        required: false
        default: ""

concurrency:
  group: publish
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies (locked)
        run: uv sync --locked --all-extras

      - name: Ruff format check
        run: uv run --locked ruff format --check .

      - name: Ruff lint
        run: uv run --locked ruff check .

      - name: Mypy
        run: uv run --locked mypy src

      - name: Pytest
        run: uv run --locked pytest -v

      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "npm"
          cache-dependency-path: packages/create-h4ckath0n/templates/fullstack/web/package-lock.json

      - name: Install frontend dependencies
        working-directory: packages/create-h4ckath0n/templates/fullstack/web
        run: npm ci

      - name: Lint frontend
        working-directory: packages/create-h4ckath0n/templates/fullstack/web
        run: npm run lint

      - name: Typecheck frontend
        working-directory: packages/create-h4ckath0n/templates/fullstack/web
        run: npm run typecheck

      - name: Test frontend
        working-directory: packages/create-h4ckath0n/templates/fullstack/web
        run: npm test

      - name: Build frontend
        working-directory: packages/create-h4ckath0n/templates/fullstack/web
        run: npm run build

  compute-version:
    runs-on: ubuntu-latest
    needs: quality
    outputs:
      npm_version: ${{ steps.compute.outputs.npm_version }}
      pypi_version: ${{ steps.compute.outputs.pypi_version }}
      dist_tag: ${{ steps.compute.outputs.dist_tag }}
      channel: ${{ steps.compute.outputs.channel }}
      base_version: ${{ steps.compute.outputs.base_version }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.14"

      - id: compute
        env:
          RELEASE_CHANNEL: ${{ inputs.channel }}
        run: python scripts/compute_versions.py

  check-existing:
    runs-on: ubuntu-latest
    needs: compute-version
    outputs:
      npm_exists: ${{ steps.check_npm.outputs.exists }}
      pypi_exists: ${{ steps.check_pypi.outputs.exists }}
    steps:
      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          registry-url: "https://registry.npmjs.org"

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.14"

      - id: check_npm
        run: |
          if [ "${{ needs.compute-version.outputs.channel }}" != "nightly" ]; then
            echo "exists=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if npm view h4ckath0n@${{ needs.compute-version.outputs.npm_version }} version >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - id: check_pypi
        env:
          PYPI_VERSION: ${{ needs.compute-version.outputs.pypi_version }}
        run: |
          if [ "${{ needs.compute-version.outputs.channel }}" != "nightly" ]; then
            echo "exists=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          python - <<'PY'
          import json
          import os
          import urllib.request
          from urllib.error import HTTPError
          version = os.environ["PYPI_VERSION"]
          try:
            with urllib.request.urlopen("https://pypi.org/pypi/h4ckath0n/json") as response:
              data = json.load(response)
            exists = version in data.get("releases", {})
          except HTTPError as exc:
            if exc.code == 404:
              exists = False
            else:
              raise
          print(f"exists={str(exists).lower()}")
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as handle:
            handle.write(f"exists={str(exists).lower()}\n")
          PY

  build-python:
    runs-on: ubuntu-latest
    needs: [compute-version, check-existing]
    if: needs.check-existing.outputs.pypi_exists != 'true'
    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.14"

      - name: Set up Python (uv)
        run: uv python install 3.11

      - name: Install dependencies (locked)
        run: uv sync --locked --all-extras

      - name: Apply version
        run: |
          python scripts/apply_versions.py \
            --npm-version "${{ needs.compute-version.outputs.npm_version }}" \
            --pypi-version "${{ needs.compute-version.outputs.pypi_version }}" \
            --channel "${{ needs.compute-version.outputs.channel }}"

      - name: Build package
        run: uv build

      - name: Upload dist
        uses: actions/upload-artifact@v6
        with:
          name: python-dist
          path: dist/*

  publish-python:
    runs-on: ubuntu-latest
    needs: [build-python, compute-version, check-existing]
    if: needs.check-existing.outputs.pypi_exists != 'true'
    permissions:
      id-token: write
      contents: read
    environment:
      name: pypi
      url: https://pypi.org/p/h4ckath0n
    steps:
      - name: Download dist
        uses: actions/download-artifact@v7
        with:
          name: python-dist
          path: dist

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist

  build-npm:
    runs-on: ubuntu-latest
    needs: [compute-version, check-existing]
    if: needs.check-existing.outputs.npm_exists != 'true'
    steps:
      - uses: actions/checkout@v6

      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "npm"
          cache-dependency-path: packages/create-h4ckath0n/package-lock.json

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.14"

      - name: Apply version
        run: |
          python scripts/apply_versions.py \
            --npm-version "${{ needs.compute-version.outputs.npm_version }}" \
            --pypi-version "${{ needs.compute-version.outputs.pypi_version }}" \
            --channel "${{ needs.compute-version.outputs.channel }}"

      - name: Install CLI dependencies
        working-directory: packages/create-h4ckath0n
        run: npm ci

      - name: Build CLI package
        working-directory: packages/create-h4ckath0n
        run: npm run build --if-present

      - name: Sync README and LICENSE into npm package
        shell: bash
        run: |
          set -euo pipefail
          install -m 0644 README.md packages/create-h4ckath0n/README.md
          install -m 0644 LICENSE packages/create-h4ckath0n/LICENSE

      - name: Pack CLI package
        working-directory: packages/create-h4ckath0n
        run: |
          mkdir -p ../../dist-npm
          npm pack --pack-destination ../../dist-npm

      - name: Upload npm dist
        uses: actions/upload-artifact@v6
        with:
          name: npm-dist
          path: dist-npm/*.tgz

  publish-npm:
    runs-on: ubuntu-latest
    needs: [build-npm, compute-version, check-existing]
    if: needs.check-existing.outputs.npm_exists != 'true'
    permissions:
      id-token: write
      contents: read
    environment:
      name: npm
    steps:
      - name: Download npm dist
        uses: actions/download-artifact@v7
        with:
          name: npm-dist
          path: dist-npm

      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          registry-url: "https://registry.npmjs.org"

      - name: Publish to npm
        working-directory: dist-npm
        run: npm publish ./*.tgz --provenance --access public --tag "${{ needs.compute-version.outputs.dist_tag }}"

  post-release-e2e:
    name: Post-release E2E (install from registries)
    runs-on: ubuntu-latest
    needs: [compute-version, check-existing, publish-npm, publish-python]
    if: needs.check-existing.outputs.npm_exists != 'true' && needs.check-existing.outputs.pypi_exists != 'true'
    env:
      CI: "1"
      DIST_TAG: ${{ needs.compute-version.outputs.dist_tag }}
      EXPECTED_NPM_VERSION: ${{ needs.compute-version.outputs.npm_version }}
      EXPECTED_PYPI_VERSION: ${{ needs.compute-version.outputs.pypi_version }}
      H4CKATH0N_DATABASE_URL: "sqlite:///./e2e-test.db"
      H4CKATH0N_RP_ID: "localhost"
      H4CKATH0N_ORIGIN: "http://localhost:5173"

    steps:
      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          registry-url: "https://registry.npmjs.org"

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"
          enable-cache: true

      - name: Set up Python (uv)
        run: uv python install 3.11

      - name: Wait for npm dist-tag to point to this release (registry lag)
        shell: bash
        run: |
          set -euo pipefail
          echo "Expect npm: h4ckath0n@${DIST_TAG} -> ${EXPECTED_NPM_VERSION}"
          for i in {1..60}; do
            v="$(npm view h4ckath0n@${DIST_TAG} version 2>/dev/null || true)"
            if [ "${v}" = "${EXPECTED_NPM_VERSION}" ]; then
              echo "OK on attempt ${i}: ${v}"
              exit 0
            fi
            echo "Attempt ${i}: got '${v}', retrying in 5s"
            sleep 5
          done
          echo "ERROR: npm tag '${DIST_TAG}' did not resolve to ${EXPECTED_NPM_VERSION} after 60 attempts" >&2
          npm view h4ckath0n@${DIST_TAG} version || true
          exit 1

      - name: Wait for PyPI version to appear (registry lag)
        shell: bash
        run: |
          set -euo pipefail
          echo "Expect PyPI: h4ckath0n == ${EXPECTED_PYPI_VERSION}"
          for i in {1..60}; do
            ok="$(python - <<'PY'
          import json, os, urllib.request
          want = os.environ["EXPECTED_PYPI_VERSION"]
          try:
            with urllib.request.urlopen("https://pypi.org/pypi/h4ckath0n/json") as r:
              data = json.load(r)
            print("true" if want in data.get("releases", {}) else "false")
          except Exception:
            print("false")
          PY
            )"
            if [ "${ok}" = "true" ]; then
              echo "OK on attempt ${i}"
              exit 0
            fi
            echo "Attempt ${i}: not visible yet, retrying in 5s"
            sleep 5
          done
          echo "ERROR: PyPI did not show ${EXPECTED_PYPI_VERSION} after 60 attempts" >&2
          exit 1

      - name: Scaffold app from published CLI (dist-tag, not latest)
        id: scaffold
        shell: bash
        run: |
          set -euo pipefail
          ROOT="$(mktemp -d)"
          APP="smoke-${GITHUB_RUN_ID}"
          APP_DIR="${ROOT}/${APP}"

          echo "APP_DIR=${APP_DIR}" >> "$GITHUB_ENV"
          echo "app_dir=${APP_DIR}" >> "$GITHUB_OUTPUT"

          cd "${ROOT}"
          npx --yes h4ckath0n@${DIST_TAG} "${APP}"
          test -d "${APP_DIR}"

      - name: Verify expected scaffold outputs exist
        shell: bash
        run: |
          set -euo pipefail
          test -f "${APP_DIR}/api/pyproject.toml"
          test -f "${APP_DIR}/web/package.json"
          test -f "${APP_DIR}/web/package-lock.json"

      - name: Pin backend to the exact published PyPI version (uv add, retry)
        shell: bash
        run: |
          set -euo pipefail
          cd "${APP_DIR}/api"
          echo "Pinning h4ckath0n==${EXPECTED_PYPI_VERSION}"

          for i in {1..60}; do
            if uv add --no-sync "h4ckath0n==${EXPECTED_PYPI_VERSION}"; then
              echo "Pinned OK on attempt ${i}"
              break
            fi
            echo "Attempt ${i} failed; sleeping 5s"
            sleep 5
            if [ "${i}" -eq 60 ]; then
              echo "ERROR: Failed to pin h4ckath0n==${EXPECTED_PYPI_VERSION} after 60 attempts" >&2
              exit 1
            fi
          done

      - name: Install backend deps and assert h4ckath0n version
        shell: bash
        run: |
          set -euo pipefail
          cd "${APP_DIR}/api"
          uv sync --all-extras
          uv run python - <<'PY'
          import os
          import h4ckath0n
          got = getattr(h4ckath0n, "__version__", None)
          want = os.environ["EXPECTED_PYPI_VERSION"]
          print("h4ckath0n version:", got)
          if got != want:
            raise SystemExit(f"Expected h4ckath0n=={want}, got {got}")
          PY

      - name: Install web deps and generate OpenAPI types
        shell: bash
        run: |
          set -euo pipefail
          cd "${APP_DIR}/web"
          npm ci
          npm run gen

      - name: Install Playwright browsers (chromium only)
        shell: bash
        run: |
          set -euo pipefail
          cd "${APP_DIR}/web"
          npx playwright install --with-deps chromium

      - name: Run E2E tests (same as CI)
        shell: bash
        run: |
          set -euo pipefail
          cd "${APP_DIR}/web"
          npx playwright test

      - name: Upload Playwright report
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: post-release-playwright-report
          path: ${{ steps.scaffold.outputs.app_dir }}/web/playwright-report/
          retention-days: 7
